<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Servernotdie - Video Downloader Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #1a1f3a 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 50px;
            animation: fadeInDown 0.8s ease;
        }

        .header h1 {
            font-size: 48px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 18px;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            background: var(--bg-secondary);
            padding: 8px;
            border-radius: 16px;
            animation: fadeIn 0.8s ease 0.2s both;
        }

        .tab-btn {
            flex: 1;
            padding: 15px 30px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 500;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .tab-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .tab-btn i {
            font-size: 20px;
        }

        /* Content Sections */
        .tab-content {
            display: none;
            animation: fadeInUp 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 30px;
        }

        .card-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-title i {
            color: var(--primary);
        }

        /* Platform Tags */
        .platforms {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }

        .platform-tag {
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s ease;
        }

        .platform-tag:hover {
            transform: translateY(-2px);
        }

        /* Input Groups */
        .input-wrapper {
            position: relative;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            gap: 12px;
            align-items: stretch;
        }

        input[type="url"],
        input[type="text"],
        input[type="file"],
        select {
            flex: 1;
            padding: 16px 20px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
        }

        input[type="file"] {
            padding: 14px;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        input::placeholder {
            color: var(--text-secondary);
        }

        /* Buttons */
        .btn {
            padding: 16px 32px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: var(--bg-tertiary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
        }

        .btn-success:hover {
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
        }

        /* Result Cards */
        .result {
            margin-top: 25px;
            padding: 25px;
            background: var(--bg-tertiary);
            border-radius: 16px;
            border-left: 4px solid var(--primary);
            display: none;
            animation: slideInUp 0.4s ease;
        }

        .result.show {
            display: block;
        }

        .result.error {
            border-left-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .result.success {
            border-left-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        /* Video Info */
        .video-info {
            display: grid;
            gap: 15px;
        }

        .info-row {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            width: 140px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-value {
            color: var(--text-primary);
            flex: 1;
        }

        /* Status Badge */
        .status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .status.processing {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .status.downloading {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary-light);
        }

        .status.completed {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .status.error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        /* Video Preview */
        .video-preview {
            margin-top: 20px;
            border-radius: 12px;
            overflow: hidden;
            background: black;
        }

        .video-preview video {
            width: 100%;
            display: block;
        }

        /* Tool Grid */
        .tool-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
        }

        .tool-card {
            background: var(--bg-tertiary);
            padding: 25px;
            border-radius: 16px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px var(--shadow);
        }

        .tool-card h3 {
            font-size: 20px;
            margin-bottom: 20px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tool-card h3 i {
            color: var(--primary);
        }

        .tool-card input,
        .tool-card select,
        .tool-card button {
            width: 100%;
            margin-bottom: 12px;
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            width: 0%;
            transition: width 0.3s ease;
            animation: progressAnimation 2s ease-in-out infinite;
        }

        @keyframes progressAnimation {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* History Section */
        .history-list {
            display: grid;
            gap: 15px;
        }

        .history-item {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .history-item:hover {
            background: var(--bg-primary);
            transform: translateX(5px);
        }

        .history-thumbnail {
            width: 100px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--bg-secondary);
        }

        .history-info {
            flex: 1;
        }

        .history-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .history-meta {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 36px;
            }

            .tab-nav {
                overflow-x: auto;
                flex-wrap: nowrap;
            }

            .tab-btn {
                min-width: 150px;
                padding: 12px 20px;
            }

            .input-group {
                flex-direction: column;
            }

            .tool-grid {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 20px;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            text-align: center;
            padding: 8px 12px;
            border-radius: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 13px;
            white-space: nowrap;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            padding: 20px 25px;
            border-radius: 12px;
            box-shadow: 0 10px 40px var(--shadow);
            border-left: 4px solid var(--primary);
            z-index: 1000;
            animation: slideInRight 0.4s ease;
            max-width: 400px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.error {
            border-left-color: var(--error);
        }

        /* Features Section */
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .feature-card {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            background: var(--bg-secondary);
        }

        .feature-icon {
            font-size: 40px;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .feature-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .feature-desc {
            font-size: 14px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-video"></i> Servernotdie Pro</h1>
            <p>Công cụ tải video và chuyển đổi media chuyên nghiệp</p>
        </div>

        <!-- Features -->
        <div class="features">
            <div class="feature-card">
                <div class="feature-icon"><i class="fas fa-bolt"></i></div>
                <div class="feature-title">Tốc độ cao</div>
                <div class="feature-desc">Tải xuống nhanh chóng với công nghệ tối ưu</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon"><i class="fas fa-hd-video"></i></div>
                <div class="feature-title">Chất lượng cao</div>
                <div class="feature-desc">Hỗ trợ 1080p, 4K và nhiều định dạng</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon"><i class="fas fa-shield-alt"></i></div>
                <div class="feature-title">An toàn</div>
                <div class="feature-desc">Bảo mật tuyệt đối, không lưu trữ dữ liệu</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon"><i class="fas fa-globe"></i></div>
                <div class="feature-title">Đa nền tảng</div>
                <div class="feature-desc">Hỗ trợ YouTube, TikTok, Facebook và nhiều hơn</div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('download')">
                <i class="fas fa-download"></i> Tải Video
            </button>
            <button class="tab-btn" onclick="switchTab('tools')">
                <i class="fas fa-tools"></i> Công Cụ
            </button>
            <button class="tab-btn" onclick="switchTab('history')">
                <i class="fas fa-history"></i> Lịch Sử
            </button>
        </div>

        <!-- Download Tab -->
        <div id="downloadTab" class="tab-content active">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-cloud-download-alt"></i>
                    Tải Video
                </div>

                <div class="platforms">
                    <span class="platform-tag"><i class="fab fa-youtube"></i> YouTube</span>
                    <span class="platform-tag"><i class="fab fa-tiktok"></i> TikTok</span>
                    <span class="platform-tag"><i class="fab fa-facebook"></i> Facebook</span>
                    <span class="platform-tag"><i class="fab fa-instagram"></i> Instagram</span>
                    <span class="platform-tag"><i class="fab fa-twitter"></i> Twitter</span>
                    <span class="platform-tag"><i class="fas fa-plus"></i> Và nhiều hơn</span>
                </div>

                <div class="input-wrapper">
                    <div class="input-group">
                        <input type="url" id="videoUrl" placeholder="Nhập link video (YouTube, TikTok, Facebook, Instagram...)">
                        <button class="btn" onclick="downloadVideo()" id="downloadBtn">
                            <i class="fas fa-download"></i> Tải Xuống
                        </button>
                    </div>
                </div>

                <div id="videoResult" class="result"></div>
            </div>
        </div>

        <!-- Tools Tab -->
        <div id="toolsTab" class="tab-content">
            <div class="tool-grid">
                <div class="tool-card">
                    <h3><i class="fas fa-image"></i> Image to ICO</h3>
                    <input type="file" id="icoFile" accept="image/*">
                    <button class="btn" onclick="convertToICO()">
                        <i class="fas fa-magic"></i> Chuyển đổi
                    </button>
                    <div id="icoResult" class="result"></div>
                </div>

                <div class="tool-card">
                    <h3><i class="fas fa-film"></i> Video to GIF</h3>
                    <input type="file" id="gifFile" accept="video/*">
                    <button class="btn" onclick="convertToGIF()">
                        <i class="fas fa-magic"></i> Chuyển đổi
                    </button>
                    <div id="gifResult" class="result"></div>
                </div>

                <div class="tool-card">
                    <h3><i class="fas fa-music"></i> Audio Converter</h3>
                    <input type="file" id="audioFile" accept="audio/*">
                    <select id="audioFormat">
                        <option value="mp3">MP3</option>
                        <option value="wav">WAV</option>
                        <option value="aac">AAC</option>
                        <option value="flac">FLAC</option>
                        <option value="ogg">OGG</option>
                        <option value="m4a">M4A</option>
                    </select>
                    <button class="btn" onclick="convertAudio()">
                        <i class="fas fa-magic"></i> Chuyển đổi
                    </button>
                    <div id="audioResult" class="result"></div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="historyTab" class="tab-content">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-clock"></i>
                    Lịch Sử Tải Xuống
                </div>
                <div id="historyList" class="history-list">
                    <p style="color: var(--text-secondary); text-align: center; padding: 40px;">
                        Chưa có lịch sử tải xuống
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://m.snd.qzz.io';
        let checkInterval;
        let downloadHistory = JSON.parse(localStorage.getItem('downloadHistory') || '[]');

        // Tab Switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.closest('.tab-btn').classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');

            if (tab === 'history') {
                displayHistory();
            }
        }

        // Show Notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}" style="font-size: 24px;"></i>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">${type === 'success' ? 'Thành công' : 'Lỗi'}</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">${message}</div>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.4s ease reverse';
                setTimeout(() => notification.remove(), 400);
            }, 3000);
        }

        // Download Video
        async function downloadVideo() {
            const url = document.getElementById('videoUrl').value.trim();
            if (!url) {
                showNotification('Vui lòng nhập link video', 'error');
                return;
            }

            const btn = document.getElementById('downloadBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Đang xử lý...';

            try {
                const response = await fetch(`${API_URL}/api/video?url=${encodeURIComponent(url)}`);
                const data = await response.json();

                if (data.code) {
                    showVideoStatus(data);
                    startChecking(data.code, url);
                    showNotification('Đang xử lý video...');
                } else {
                    throw new Error('Không thể xử lý video');
                }
            } catch (error) {
                showError('videoResult', error.message);
                showNotification(error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-download"></i> Tải Xuống';
            }
        }

        // Check Status
        function startChecking(code, url) {
            if (checkInterval) clearInterval(checkInterval);

            checkInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_URL}/api/videos/code=${code}`);
                    const data = await response.json();

                    showVideoStatus(data);

                    if (data.status === 'completed') {
                        clearInterval(checkInterval);
                        showNotification('Video đã sẵn sàng để tải xuống!');
                        addToHistory(data, url);
                    } else if (data.status === 'error') {
                        clearInterval(checkInterval);
                        showNotification('Có lỗi xảy ra khi xử lý video', 'error');
                    }
                } catch (error) {
                    console.error('Error checking status:', error);
                }
            }, 2000);
        }

        // Show Video Status
        function showVideoStatus(data) {
            const result = document.getElementById('videoResult');
            result.classList.add('show');
            result.classList.remove('error');

            let statusIcon = '';
            switch(data.status) {
                case 'processing':
                case 'downloading':
                    statusIcon = '<i class="fas fa-spinner fa-spin"></i>';
                    break;
                case 'completed':
                    statusIcon = '<i class="fas fa-check-circle"></i>';
                    break;
                case 'error':
                    statusIcon = '<i class="fas fa-times-circle"></i>';
                    break;
            }

            let content = '<div class="video-info">';

            if (data.title) {
                content += `
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-heading"></i> Tiêu đề:</span>
                        <span class="info-value">${data.title}</span>
                    </div>
                `;
            }

            content += `
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-info-circle"></i> Trạng thái:</span>
                    <span class="info-value">
                        <span class="status ${data.status}">
                            ${statusIcon}
                            ${getStatusText(data.status)}
                        </span>
                    </span>
                </div>
            `;

            if (data.duration) {
                content += `
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-clock"></i> Thời lượng:</span>
                        <span class="info-value">${data.duration}</span>
                    </div>
                `;
            }

            if (data.quality) {
                content += `
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-hd-video"></i> Chất lượng:</span>
                        <span class="info-value">${data.quality}</span>
                    </div>
                `;
            }

            content += '</div>';

            if (data.status === 'processing' || data.status === 'downloading') {
                content += '<div class="progress-bar"><div class="progress-fill" style="width: 60%"></div></div>';
            }

            if (data.status === 'completed') {
                content += `
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="window.open('${API_URL}${data.download_url}', '_blank')">
                            <i class="fas fa-download"></i> Tải Xuống
                        </button>
                        <button class="btn" onclick="previewVideo('${API_URL}${data.stream_url}')">
                            <i class="fas fa-play"></i> Xem Trước</button>
                        <button class="btn" onclick="copyToClipboard('${API_URL}${data.download_url}')">
                            <i class="fas fa-copy"></i> Copy Link
                        </button>
                    </div>
                    <div id="videoPreview"></div>
                `;
            }

            result.innerHTML = content;
        }

        // Preview Video
        function previewVideo(url) {
            const preview = document.getElementById('videoPreview');
            preview.innerHTML = `
                <div class="video-preview">
                    <video controls src="${url}" autoplay></video>
                </div>
            `;
        }

        // Copy to Clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Đã copy link vào clipboard!');
            }).catch(() => {
                showNotification('Không thể copy link', 'error');
            });
        }

        // Get Status Text
        function getStatusText(status) {
            const texts = {
                'processing': 'Đang xử lý',
                'downloading': 'Đang tải xuống',
                'completed': 'Hoàn thành',
                'error': 'Lỗi'
            };
            return texts[status] || status;
        }

        // Show Error
        function showError(resultId, message) {
            const result = document.getElementById(resultId);
            result.classList.add('show', 'error');
            result.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: var(--error);"></i>
                    <div>
                        <strong>Lỗi:</strong> ${message}
                    </div>
                </div>
            `;
        }

        // Show Success
        function showSuccess(resultId, message, downloadUrl) {
            const result = document.getElementById(resultId);
            result.classList.add('show', 'success');
            result.classList.remove('error');
            result.innerHTML = `
                <div class="video-info">
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-check-circle"></i> Trạng thái:</span>
                        <span class="info-value">
                            <span class="status completed">
                                <i class="fas fa-check-circle"></i>
                                Hoàn thành
                            </span>
                        </span>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="window.open('${API_URL}${downloadUrl}', '_blank')">
                        <i class="fas fa-download"></i> Tải File
                    </button>
                </div>
            `;
        }

        // Upload and Convert
        async function uploadAndConvert(endpoint, fileInput, resultId, format = null) {
            const file = fileInput.files[0];
            if (!file) {
                showNotification('Vui lòng chọn file', 'error');
                return;
            }

            // Check file size (max 100MB)
            if (file.size > 100 * 1024 * 1024) {
                showNotification('File quá lớn! Vui lòng chọn file nhỏ hơn 100MB', 'error');
                return;
            }

            const result = document.getElementById(resultId);
            result.classList.add('show');
            result.classList.remove('error', 'success');
            result.innerHTML = `
                <div style="text-align: center;">
                    <span class="spinner" style="width: 24px; height: 24px; border-width: 3px;"></span>
                    <p style="margin-top: 15px; color: var(--text-secondary);">Đang xử lý... Vui lòng đợi</p>
                    <div class="progress-bar"><div class="progress-fill" style="width: 70%"></div></div>
                </div>
            `;

            // Create FormData for file upload
            const formData = new FormData();
            formData.append('file', file);

            try {
                // Upload file first
                const uploadResponse = await fetch(`${API_URL}/api/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!uploadResponse.ok) {
                    throw new Error('Tải file lên thất bại');
                }

                const uploadData = await uploadResponse.json();

                // Convert file
                const requestBody = {
                    file_url: uploadData.url || URL.createObjectURL(file)
                };

                if (format) {
                    requestBody.format = format;
                }

                const response = await fetch(`${API_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (data.download_url) {
                    showSuccess(resultId, 'Chuyển đổi thành công!', data.download_url);
                    showNotification('Chuyển đổi file thành công!');
                } else {
                    throw new Error('Chuyển đổi thất bại');
                }
            } catch (error) {
                showError(resultId, error.message);
                showNotification(error.message, 'error');
            }
        }

        // Convert to ICO
        function convertToICO() {
            uploadAndConvert('/api/tool/image-to-ico', document.getElementById('icoFile'), 'icoResult');
        }

        // Convert to GIF
        function convertToGIF() {
            uploadAndConvert('/api/tool/video-to-gif', document.getElementById('gifFile'), 'gifResult');
        }

        // Convert Audio
        function convertAudio() {
            const format = document.getElementById('audioFormat').value;
            uploadAndConvert('/api/tool/audio-convert', document.getElementById('audioFile'), 'audioResult', format);
        }

        // Add to History
        function addToHistory(data, url) {
            const historyItem = {
                url: url,
                code: data.code,
                title: data.title || 'Untitled',
                thumbnail: data.thumbnail || '',
                duration: data.duration || '',
                downloadUrl: data.download_url,
                streamUrl: data.stream_url,
                timestamp: new Date().toISOString()
            };

            downloadHistory.unshift(historyItem);
            
            // Keep only last 20 items
            if (downloadHistory.length > 20) {
                downloadHistory = downloadHistory.slice(0, 20);
            }

            localStorage.setItem('downloadHistory', JSON.stringify(downloadHistory));
        }

        // Display History
        function displayHistory() {
            const historyList = document.getElementById('historyList');
            
            if (downloadHistory.length === 0) {
                historyList.innerHTML = `
                    <p style="color: var(--text-secondary); text-align: center; padding: 40px;">
                        <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                        Chưa có lịch sử tải xuống
                    </p>
                `;
                return;
            }

            historyList.innerHTML = downloadHistory.map(item => `
                <div class="history-item" onclick="loadHistoryItem('${item.code}')">
                    ${item.thumbnail ? 
                        `<img src="${item.thumbnail}" class="history-thumbnail" alt="${item.title}">` :
                        `<div class="history-thumbnail" style="display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-video" style="font-size: 24px; color: var(--text-secondary);"></i>
                        </div>`
                    }
                    <div class="history-info">
                        <div class="history-title">${item.title}</div>
                        <div class="history-meta">
                            <i class="fas fa-clock"></i> ${formatDate(item.timestamp)}
                            ${item.duration ? ` • <i class="fas fa-stopwatch"></i> ${item.duration}` : ''}
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="event.stopPropagation(); window.open('${API_URL}${item.downloadUrl}', '_blank')" style="padding: 10px 20px;">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn" onclick="event.stopPropagation(); deleteHistoryItem('${item.code}')" style="padding: 10px 20px; background: var(--error);">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Load History Item
        function loadHistoryItem(code) {
            const item = downloadHistory.find(h => h.code === code);
            if (item) {
                document.getElementById('videoUrl').value = item.url;
                switchTab('download');
                document.querySelector('.tab-btn').click();
                
                showVideoStatus({
                    url: item.url,
                    code: item.code,
                    title: item.title,
                    thumbnail: item.thumbnail,
                    duration: item.duration,
                    download_url: item.downloadUrl,
                    stream_url: item.streamUrl,
                    status: 'completed',
                    quality: '1080p'
                });
            }
        }

        // Delete History Item
        function deleteHistoryItem(code) {
            downloadHistory = downloadHistory.filter(h => h.code !== code);
            localStorage.setItem('downloadHistory', JSON.stringify(downloadHistory));
            displayHistory();
            showNotification('Đã xóa khỏi lịch sử');
        }

        // Clear All History
        function clearAllHistory() {
            if (confirm('Bạn có chắc muốn xóa toàn bộ lịch sử?')) {
                downloadHistory = [];
                localStorage.setItem('downloadHistory', JSON.stringify(downloadHistory));
                displayHistory();
                showNotification('Đã xóa toàn bộ lịch sử');
            }
        }

        // Format Date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Vừa xong';
            if (minutes < 60) return `${minutes} phút trước`;
            if (hours < 24) return `${hours} giờ trước`;
            if (days < 7) return `${days} ngày trước`;
            
            return date.toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + Enter to download
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab.id === 'downloadTab') {
                    downloadVideo();
                }
            }
            
            // Ctrl/Cmd + K to focus input
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('videoUrl').focus();
            }
        });

        // Drag and Drop Support
        ['downloadTab', 'toolsTab'].forEach(tabId => {
            const tab = document.getElementById(tabId);
            
            tab.addEventListener('dragover', (e) => {
                e.preventDefault();
                tab.style.opacity = '0.8';
            });
            
            tab.addEventListener('dragleave', () => {
                tab.style.opacity = '1';
            });
            
            tab.addEventListener('drop', (e) => {
                e.preventDefault();
                tab.style.opacity = '1';
                
                const url = e.dataTransfer.getData('text/plain');
                if (url && tabId === 'downloadTab') {
                    document.getElementById('videoUrl').value = url;
                    showNotification('Đã dán link video');
                }
            });
        });

        // Auto-detect URL from clipboard
        async function checkClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                if (text && (text.includes('youtube.com') || text.includes('youtu.be') || 
                    text.includes('tiktok.com') || text.includes('facebook.com') || 
                    text.includes('instagram.com') || text.includes('twitter.com'))) {
                    
                    const urlInput = document.getElementById('videoUrl');
                    if (!urlInput.value) {
                        const notification = document.createElement('div');
                        notification.className = 'notification';
                        notification.innerHTML = `
                            <div>
                                <div style="font-weight: 600; margin-bottom: 8px;">
                                    <i class="fas fa-clipboard"></i> Phát hiện link video trong clipboard
                                </div>
                                <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">
                                    ${text.substring(0, 50)}...
                                </div>
                                <button class="btn" onclick="pasteFromClipboard('${text}')" style="width: 100%; padding: 10px;">
                                    <i class="fas fa-paste"></i> Dán vào
                                </button>
                            </div>
                        `;
                        document.body.appendChild(notification);
                        
                        setTimeout(() => {
                            notification.style.animation = 'slideInRight 0.4s ease reverse';
                            setTimeout(() => notification.remove(), 400);
                        }, 5000);
                    }
                }
            } catch (err) {
                // Clipboard access denied or not supported
            }
        }

        function pasteFromClipboard(text) {
            document.getElementById('videoUrl').value = text;
            document.querySelectorAll('.notification').forEach(n => n.remove());
            showNotification('Đã dán link video');
        }

        // Check clipboard on page load
        setTimeout(checkClipboard, 1000);

        // Service Worker for offline support (optional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(() => {
                    // Service worker registration failed
                });
            });
        }

        // Add Clear History Button to History Tab
        document.addEventListener('DOMContentLoaded', () => {
            const historyCard = document.querySelector('#historyTab .card');
            if (historyCard) {
                const titleDiv = historyCard.querySelector('.card-title');
                const clearBtn = document.createElement('button');
                clearBtn.className = 'btn';
                clearBtn.style.cssText = 'margin-left: auto; padding: 8px 16px; font-size: 14px;';
                clearBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Xóa Tất Cả';
                clearBtn.onclick = clearAllHistory;
                
                const titleContainer = document.createElement('div');
                titleContainer.style.cssText = 'display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;';
                titleContainer.appendChild(titleDiv.cloneNode(true));
                titleContainer.appendChild(clearBtn);
                
                titleDiv.replaceWith(titleContainer);
            }
        });

        // Paste Detection
        document.getElementById('videoUrl').addEventListener('paste', () => {
            setTimeout(() => {
                showNotification('Đã dán link video');
            }, 100);
        });

        // Prevent form submission on Enter
        document.getElementById('videoUrl').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                downloadVideo();
            }
        });

        // Check API Health
        async function checkAPIHealth() {
            try {
                const response = await fetch(`${API_URL}/health`);
                if (response.ok) {
                    console.log('API is healthy');
                }
            } catch (error) {
                showNotification('Không thể kết nối đến server', 'error');
            }
        }

        // Check on load
        checkAPIHealth();

        // Auto-save form data
        const autoSave = {
            save: () => {
                const data = {
                    videoUrl: document.getElementById('videoUrl').value,
                    audioFormat: document.getElementById('audioFormat').value
                };
                localStorage.setItem('formData', JSON.stringify(data));
            },
            load: () => {
                const data = JSON.parse(localStorage.getItem('formData') || '{}');
                if (data.videoUrl) document.getElementById('videoUrl').value = data.videoUrl;
                if (data.audioFormat) document.getElementById('audioFormat').value = data.audioFormat;
            }
        };

        // Load saved data on page load
        window.addEventListener('load', () => {
            autoSave.load();
        });

        // Save on input
        document.getElementById('videoUrl').addEventListener('input', autoSave.save);
        document.getElementById('audioFormat').addEventListener('change', autoSave.save);
    </script>
</body>
</html>
                            
